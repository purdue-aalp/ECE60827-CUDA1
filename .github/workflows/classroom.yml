name: Autograding Tests

'on':
  - push
  - repository_dispatch

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  run-autograding-tests:
    # you need to launch a self-hosted runner in the classroom organization with this name
    runs-on: tgrogers-gpu01

    # container:
    #   image: ghcr.io/accel-sim/accel-sim-framework:Ubuntu-24.04-cuda-12.8-minimal

    if: github.actor != 'github-classroom[bot]'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # -----------------------------
    # Build step (fails job on error)
    # -----------------------------
    - name: Build
      run: |
        set -e
        module load gcc/11.4.1 cuda
        mkdir -p build
        cd build
        cmake ..
        make -j4

    # -----------------------------
    # Build the grader
    # -----------------------------
    - name: Build Grader
      run: |
        set -e
        module load gcc/11.4.1 cuda
        cd build
        nvcc -o grader ../autograder/grader.cu \
          -I../include \
          -Lsrc \
          -lcudaLib -lcpuLib \
          -lcurand \
          -Xcompiler -Wall

    # -----------------------------
    # Part A: SAXPY Tests (50 points)
    # -----------------------------
    - name: Part A - SAXPY
      id: part-a
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: "Part A - SAXPY (50 points)"
        command: >
          bash -lc '
            module load cuda &&
            cd build &&
            ./grader --part-a
          '
        timeout: 60
        max-score: 50

    # -----------------------------
    # Part B: Monte Carlo Pi Tests (50 points)
    # -----------------------------
    - name: Part B - Monte Carlo Pi
      id: part-b
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: "Part B - Monte Carlo Pi (50 points)"
        command: >
          bash -lc '
            module load cuda &&
            cd build &&
            ./grader --part-b
          '
        timeout: 60
        max-score: 50

    # -----------------------------
    # Report grades (MUST be last)
    # -----------------------------
    - name: Autograding Reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        PART-A_RESULTS: "${{ steps.part-a.outputs.result }}"
        PART-B_RESULTS: "${{ steps.part-b.outputs.result }}"
      with:
        runners: part-a,part-b
